# คำอธิบายการทำงานของ `mm_bot.py`

## ภาพรวม
บอท `AsterMarketMaker` ทำหน้าที่เป็น market maker สำหรับสัญญา ASTERUSDT บน ASTER Exchange (futures API) โดยจะส่งคำสั่งซื้อ (bid) และขาย (ask) คร่อมราคา mid ของตลาด คอยรีเฟรชคำสั่งเมื่อหมดอายุ จัดการคำสั่งที่ถูกเติมบางส่วน และติดตามสถานะสินทรัพย์พร้อมปิดสถานะเมื่อมีกำไรตามเงื่อนไขที่กำหนด

## การตั้งค่าที่สำคัญ
ตัวแปรกำหนดค่าทั้งหมดอยู่ช่วงต้นไฟล์ สามารถปรับได้ตามความต้องการ
- `API_KEY` / `API_SECRET`: ดึงจาก environment (`ASTERDEX_API_KEY`/`ASTERDEX_API_SECRET`); ใช้ key ทดสอบเป็นค่าเริ่มต้น
- `SYMBOL`: คู่สัญญาที่เทรด (ค่าเริ่มต้น `ASTERUSDT`)
- `SPREAD_USD`: ครึ่งหนึ่งของสเปรดที่ใช้เว้นราคาซื้อ-ขายรอบ mid
- `ORDER_SIZE_USD`: มูลค่า (เป็น USDT) ของคำสั่งแต่ละฝั่ง
- `ORDER_TIMEOUT_SECONDS`: อายุคำสั่ง หากยังไม่ถูกเติมครบจะยกเลิกและออกคำสั่งใหม่
- `COUNTER_FILL_WAIT_SECONDS`: เวลารอให้คำสั่งฝั่งตรงข้ามถูกเติม หลังจากอีกฝั่งถูกเติมก่อน
- `INVENTORY_THRESHOLD_USD`, `MIN_PROFIT_TO_CLOSE`, `PNL_HOLD_SECONDS`: เงื่อนไขปิดสถานะเมื่อถือครองมากและกำไรนิ่งนานพอ
- `USE_TESTNET`: ตั้ง `True` เพื่อสลับไปยัง endpoint ทดสอบ

## ขั้นตอนการทำงานหลัก
1. เรียก `configure_logging()` เพื่อเปิดใช้งาน logging ตามระดับ `MM_LOG_LEVEL`
2. สร้างอินสแตนซ์ `AsterMarketMaker` ซึ่งจะโหลดข้อมูลสัญญา (lot size, tick size, min notional) และเตรียม session พร้อมลายเซ็น HMAC สำหรับ REST API
3. ใน `run()`
   - ยกเลิกคำสั่งค้างที่เปิดอยู่ก่อนหน้า
   - เข้าลูปหลัก ทำงานทุก `SLEEP_SECONDS`
   - อัปเดตสถานะคำสั่งซื้อ/ขาย หากคำสั่งฝั่งใดไม่อยู่จะออกคำสั่งใหม่ทั้งคู่
   - ตรวจสอบตัวจับเวลา (`_evaluate_cycle_timers`) เพื่อรีเฟรชคำสั่งเมื่อหมดเวลา หรือเมื่ออีกฝั่งไม่ถูกเติมตามกำหนด
   - ตรวจสอบสถานะตำแหน่งทุก `POSITION_CHECK_INTERVAL` วินาที เพื่อบริหาร inventory และกำไร

## การจัดการคำสั่งซื้อขาย
- `_place_new_quotes()` ดึง bid/ask ปัจจุบัน คำนวณ mid แล้วตั้งราคาซื้อ/ขายด้วยการปัดเศษตาม `price_tick`
- ตรวจสอบขั้นต่ำของจำนวนและมูลค่าก่อนส่งคำสั่ง
- เรียก `_place_limit_order()` เพื่อส่งคำสั่ง GTC ทั้งสองฝั่ง และบันทึกลง `OrderState`
- `_refresh_order_state()` ดึงสถานะล่าสุดจาก `/fapi/v1/order` เพื่อดูว่าถูกเติม ยกเลิก หรือหมดอายุแล้วหรือไม่
- `_evaluate_cycle_timers()` ดูว่าทั้งสองฝั่งถูกเติมครบหรือยัง ถ้าไม่ครบและหมดเวลาที่ตั้งไว้จะยกเลิกแล้วเริ่มรอบใหม่
- `_cancel_remaining_orders()` ใช้เมื่อจะรีเซ็ตหรือปิดโปรแกรม เพื่อไม่ทิ้งคำสั่งค้าง

## การบริหารสถานะและ PnL
- `_check_inventory()` อ่านข้อมูลจาก `/fapi/v2/positionRisk` เพื่อดูปริมาณคงค้าง (positionAmt), กำไรขาดทุนที่ยังไม่รับรู้ และ mark price
- หากปลายทางตอบกลับ `code = -1000` พร้อมข้อความ unknown error ระบบจะถือว่าเป็นตำแหน่งว่างชั่วคราวและจะไม่แจ้งเตือนซ้ำ เพื่อลดสัญญาณเตือนที่เกิดจากข้อผิดพลาดฝั่ง API
- หากถือสถานะมากกว่าค่า `INVENTORY_THRESHOLD_USD` และกำไรถึง `MIN_PROFIT_TO_CLOSE` จะเริ่มนับเวลา
- เมื่อถือกำไรต่อเนื่องเกิน `PNL_HOLD_SECONDS` จะเรียก `_flatten_position()` ส่งคำสั่ง market `reduceOnly` เพื่อปิดสถานะทั้งหมด

## ระบบ REST และการลงลายเซ็น
- `_request()` รวมการสร้างคำขอทุกประเภท ทั้ง GET/POST/DELETE และตรวจสอบรหัสตอบกลับ
- `_sign_params()` เติม `timestamp`, `recvWindow` และคำนวณลายเซ็น HMAC SHA256 ตามข้อกำหนดของ ASTER API
- มีฟังก์ชันช่วยเหลืออื่น เช่น `_fetch_mid_price()`, `_fetch_symbol_info()` และตัวช่วยปัดเศษราคา/ปริมาณ (`_round_price`, `_floor_to_step`)

## การใช้งานเบื้องต้น
```bash
export ASTERDEX_API_KEY="<your-key>"
export ASTERDEX_API_SECRET="<your-secret>"
python3 mm_bot.py
```

บอทจะเริ่มวางคำสั่งสองฝั่งและจัดการอัตโนมัติ ตามค่าการตั้งที่ให้ไว้
